#!/bin/bash -v

# Verbose and exit on errors
set -ex

GITHUB_REF_NAME=$1
MATRIX_NAME=$2

# Do additional tasks that are common across all images, 
# but not suitable for inclusion in install.sh
echo "Running install_common.sh"

# Limit the maximum length of systemd-journald logs
mkdir -p /etc/systemd/journald.conf.d
cat > /etc/systemd/journald.conf.d/60-limit-log-size.conf <<EOF
# Added by Photonvision to keep the logs to a reasonable size
[Journal]
SystemMaxUse=100M
EOF

# Create user photon:vision login
echo "creating photon user"
useradd photon -m -b /home -s /bin/bash
usermod -a -G sudo photon
echo 'photon ALL=(ALL) NOPASSWD: ALL' | tee -a /etc/sudoers.d/010_photon-nopasswd >/dev/null
chmod 0440 /etc/sudoers.d/010_photon-nopasswd

echo "photon:vision" | chpasswd

# Add a helpful message to the logon screen
# ASCII Art generated by: https://www.asciiart.eu/image-to-ascii
cp -f /tmp/build/files/issue.txt /etc/issue
cp -f /etc/issue /etc/issue.net
sed -i 's/#Banner none/Banner \/etc\/issue.net/g' /etc/ssh/sshd_config

# Add photon version file
mkdir -p /opt/photonvision/
echo "${GITHUB_REF_NAME};${MATRIX_NAME}" > /opt/photonvision/image-version